<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>90-Day Spiritual Journey Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body { 
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #1a202c;
  }
  
  .container { 
    max-width: 1400px; 
    margin: 0 auto; 
    padding: 20px;
  }
  
  .header {
    text-align: center;
    margin-bottom: 40px;
    color: white;
  }
  
  .header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .participant-info {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    padding: 16px;
    color: white;
    font-size: 1.1rem;
    margin-bottom: 30px;
  }
  
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
  }
  
  .card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    backdrop-filter: blur(10px);
  }
  
  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 48px rgba(0,0,0,0.15);
  }
  
  .card-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
  }
  
  .card-value {
    font-size: 2.25rem;
    font-weight: 700;
    margin-bottom: 8px;
    line-height: 1;
  }
  
  .card-subtitle {
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .progress-ring {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto 16px;
  }
  
  .progress-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }
  
  .progress-ring circle {
    fill: none;
    stroke-width: 6;
  }
  
  .progress-bg { stroke: #e5e7eb; }
  .progress-fill { 
    stroke: #10b981; 
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
  }
  
  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
  }
  
  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .status-excellent { background: #dcfce7; color: #166534; }
  .status-good { background: #fef3c7; color: #92400e; }
  .status-warning { background: #fee2e2; color: #991b1b; }
  
  .chart-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    backdrop-filter: blur(10px);
  }
  
  .chart-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: #1f2937;
  }
  
  .practices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }
  
  .practice-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    border-left: 4px solid #10b981;
  }
  
  .practice-name {
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 1.1rem;
  }
  
  .practice-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .practice-percentage {
    font-size: 1.5rem;
    font-weight: 700;
    color: #10b981;
  }
  
  .practice-bar {
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
  }
  
  .practice-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #34d399);
    border-radius: 4px;
    transition: width 0.8s ease;
  }
  
  .insights-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    backdrop-filter: blur(10px);
  }
  
  .insights-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .insight-item {
    background: #f8fafc;
    border-left: 4px solid #3b82f6;
    border-radius: 0 8px 8px 0;
    padding: 16px;
    margin-bottom: 12px;
  }
  
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    font-size: 1.1rem;
    color: white;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 12px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .trend-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .trend-up { color: #10b981; }
  .trend-down { color: #ef4444; }
  .trend-stable { color: #6b7280; }
  
  .weekly-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 16px;
  }
  
  .calendar-day {
    aspect-ratio: 1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 500;
    border: 2px solid #e5e7eb;
  }
  
  .calendar-day.completed {
    background: #10b981;
    color: white;
    border-color: #10b981;
  }
  
  .calendar-day.partial {
    background: #f59e0b;
    color: white;
    border-color: #f59e0b;
  }
  
  @media (max-width: 768px) {
    .header h1 { font-size: 2rem; }
    .dashboard-grid { grid-template-columns: 1fr; }
    .practices-grid { grid-template-columns: 1fr; }
    .container { padding: 16px; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>✨ 90-Day Spiritual Journey</h1>
      <div class="participant-info">
        <strong>Participant:</strong> <span id="pid">Loading...</span>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      Loading your spiritual journey insights...
    </div>

    <div id="dashboard" style="display:none;">
      <div class="dashboard-grid">
        <div class="card">
          <div class="card-title">Overall Progress</div>
          <div class="progress-ring">
            <svg>
              <circle class="progress-bg" cx="40" cy="40" r="36"></circle>
              <circle class="progress-fill" cx="40" cy="40" r="36" 
                      stroke-dasharray="226" stroke-dashoffset="226" id="progress-circle"></circle>
            </svg>
            <div class="progress-text" id="progress-percent">0%</div>
          </div>
          <div class="card-subtitle">
            <span id="progress-status" class="status-pill">Calculating...</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Journey Progress</div>
          <div class="card-value" id="days-progress">Day 0 / 90</div>
          <div class="card-subtitle">
            <span id="days-left">90 days remaining</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Momentum</div>
          <div class="card-value" id="momentum-score">—</div>
          <div class="card-subtitle">
            <span id="momentum-trend" class="trend-indicator">Calculating trend...</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Focus Area</div>
          <div class="card-value" id="focus-area">—</div>
          <div class="card-subtitle">Needs attention this week</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">📈 Weekly Progress Trend</div>
        <div style="position: relative; height: 300px;">
          <canvas id="trendChart"></canvas>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">📊 Daily Consistency Heatmap (Last 6 Weeks)</div>
        <div style="position: relative; height: 200px;">
          <canvas id="heatmapChart"></canvas>
        </div>
      </div>

      <div class="practices-grid" id="practicesGrid">
        <!-- Practice cards will be inserted here -->
      </div>

      <div class="insights-section">
        <div class="insights-title">
          🎯 Personalized Insights
        </div>
        <div id="insights-container">
          <!-- Insights will be generated here -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQERkbRqvUyktHeUw-DvLVNNIzvR50N0oHC-bpDwx6Lj33-o9uIiGN-ucd9r80Tq3l5_WroECTpI-gz/pub?gid=262595972&single=true&output=csv";
    const TARGET = 0.95;
    const DAILY_PRACTICES = new Set(["Bible Reading","Morning Intimacy","Midnight Intercessory Prayer"]);
    
    const qs = new URLSearchParams(location.search);
    const PID = (qs.get("id") || "").trim().toLowerCase();

    function csvToRows(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(",");
      return lines.map(line => {
        const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s => s.replace(/^"|"$/g,""));
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]||"").trim());
        return obj;
      });
    }

    function ymd(d) { return d.toISOString().slice(0,10); }
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
    function parseDate(s){ const d = new Date(s); return isNaN(d) ? null : d; }
    function pctFmt(x) { return (Math.round(x*1000)/10).toFixed(1) + "%"; }

    function updateProgressRing(percentage) {
      const circle = document.getElementById('progress-circle');
      const text = document.getElementById('progress-percent');
      const circumference = 2 * Math.PI * 36;
      const offset = circumference - (percentage / 100) * circumference;
      circle.style.strokeDashoffset = offset;
      text.textContent = Math.round(percentage) + '%';
      
      // Update color based on progress
      if (percentage >= 95) {
        circle.style.stroke = '#10b981';
      } else if (percentage >= 80) {
        circle.style.stroke = '#f59e0b';
      } else {
        circle.style.stroke = '#ef4444';
      }
    }

    function getStatusPill(attainment) {
      if (attainment >= TARGET) {
        return '<span class="status-pill status-excellent">Excellent</span>';
      } else if (attainment >= 0.8) {
        return '<span class="status-pill status-good">Good Progress</span>';
      } else {
        return '<span class="status-pill status-warning">Needs Focus</span>';
      }
    }

    function generateInsights(data, attainment, dayNum, byPractice) {
      const insights = [];
      
      // Progress insight
      if (attainment >= 0.95) {
        insights.push("🌟 Outstanding commitment! You're excelling in your spiritual disciplines and on track to achieve your 90-day goal.");
      } else if (attainment >= 0.8) {
        insights.push("💪 Great progress! You're doing well but have room to strengthen your consistency in the coming weeks.");
      } else {
        insights.push("🎯 There's opportunity to grow! Focus on building consistent habits - small daily actions compound into transformational results.");
      }

      // Practice-specific insights
      const practices = Object.entries(byPractice).map(([name, stats]) => ({
        name,
        percentage: stats.total ? stats.done / stats.total : 0
      })).sort((a, b) => b.percentage - a.percentage);

      if (practices.length > 0) {
        const strongest = practices[0];
        const weakest = practices[practices.length - 1];
        
        if (strongest.percentage > 0.9) {
          insights.push(`⭐ Your ${strongest.name} practice is exemplary at ${pctFmt(strongest.percentage)}! This consistency is building a strong foundation.`);
        }
        
        if (weakest.percentage < 0.7) {
          insights.push(`🔧 Consider focusing extra attention on ${weakest.name} (${pctFmt(weakest.percentage)}). Try linking it to an existing strong habit.`);
        }
      }

      // Time-based insights
      const timeLeft = 90 - dayNum;
      if (timeLeft <= 30 && attainment < 0.9) {
        insights.push("⚡ You're in the final stretch! This is the perfect time to push for consistency and finish strong.");
      } else if (timeLeft > 60 && attainment > 0.9) {
        insights.push("🚀 Amazing early momentum! Maintain this rhythm and you'll exceed your 90-day goals.");
      }

      return insights;
    }

    function createPracticeCard(name, stats) {
      const percentage = stats.total ? (stats.done / stats.total) * 100 : 0;
      const completedCount = Math.round(stats.done);
      
      return `
        <div class="practice-card">
          <div class="practice-name">${name}</div>
          <div class="practice-stats">
            <span class="practice-percentage">${Math.round(percentage)}%</span>
            <span style="font-size: 0.875rem; color: #6b7280;">${completedCount}/${stats.total}</span>
          </div>
          <div class="practice-bar">
            <div class="practice-bar-fill" style="width: ${percentage}%"></div>
          </div>
        </div>
      `;
    }

    async function main() {
      document.getElementById('pid').textContent = PID || '(provide ?id=your_email)';
      
      if (!PID) {
        document.getElementById('loading').innerHTML = '<div style="text-align: center; color: white;">Please add ?id=your_email to the URL to view your dashboard</div>';
        return;
      }

      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const rows = csvToRows(text).filter(r => r.participant_id.toLowerCase() === PID);

        if (!rows.length) {
          document.getElementById('loading').innerHTML = '<div style="text-align: center; color: white;">No data found for this participant. Please check your email address.</div>';
          return;
        }

        // Calculate program progress
        const weekStarts = rows.map(r => parseDate(r.week_start)).filter(Boolean).sort((a,b)=>a-b);
        const programStart = startOfDay(weekStarts[0]);
        const today = startOfDay(new Date());
        const dayNum = Math.max(1, Math.min(90, Math.floor((today - programStart)/(1000*60*60*24)) + 1));
        const daysLeft = Math.max(0, 90 - dayNum);

        // Calculate statistics
        let completed = 0, possible = 0;
        const byPractice = {};
        const byWeek = {};
        const dailyData = [];

        rows.forEach(r => {
          const val = Number(r.value || 0);
          const date = parseDate(r.date);
          const wk = r.week_start;
          
          possible += 1;
          completed += val;

          byPractice[r.practice] = byPractice[r.practice] || {done:0, total:0};
          byPractice[r.practice].done += val;
          byPractice[r.practice].total += 1;

          byWeek[wk] = byWeek[wk] || {done:0, total:0};
          byWeek[wk].done += val;
          byWeek[wk].total += 1;

          if (DAILY_PRACTICES.has(r.practice) && date) {
            dailyData.push({date: ymd(date), value: val, practice: r.practice});
          }
        });

        const attainment = possible ? (completed / possible) : 0;
        
        // Update UI
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        updateProgressRing(attainment * 100);
        document.getElementById('progress-status').innerHTML = getStatusPill(attainment);
        document.getElementById('days-progress').textContent = `Day ${dayNum} / 90`;
        document.getElementById('days-left').textContent = `${daysLeft} days remaining`;

        // Calculate momentum (improvement over recent weeks)
        const weekKeys = Object.keys(byWeek).sort();
        let momentum = "Steady";
        if (weekKeys.length >= 2) {
          const recent = byWeek[weekKeys[weekKeys.length - 1]];
          const previous = byWeek[weekKeys[weekKeys.length - 2]];
          const recentPct = recent.total ? recent.done / recent.total : 0;
          const prevPct = previous.total ? previous.done / previous.total : 0;
          
          if (recentPct > prevPct + 0.1) momentum = "Strong ↗️";
          else if (recentPct < prevPct - 0.1) momentum = "Declining ↘️";
        }
        document.getElementById('momentum-score').textContent = momentum;

        // Find focus area (weakest practice)
        let weakest = null, weakestPct = 1;
        Object.keys(byPractice).forEach(k => {
          const pct = byPractice[k].total ? (byPractice[k].done/byPractice[k].total) : 0;
          if (pct < weakestPct) { weakestPct = pct; weakest = k; }
        });
        document.getElementById('focus-area').textContent = weakest || "All practices";

        // Create practice cards
        const practicesHtml = Object.entries(byPractice)
          .sort(([,a], [,b]) => (b.done/b.total) - (a.done/a.total))
          .map(([name, stats]) => createPracticeCard(name, stats))
          .join('');
        document.getElementById('practicesGrid').innerHTML = practicesHtml;

        // Generate insights
        const insights = generateInsights(rows, attainment, dayNum, byPractice);
        const insightsHtml = insights.map(insight => 
          `<div class="insight-item">${insight}</div>`
        ).join('');
        document.getElementById('insights-container').innerHTML = insightsHtml;

        // Create charts
        createTrendChart(byWeek);
        createHeatmapChart(dailyData);

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML = '<div style="text-align: center; color: white;">Error loading data. Please try again later.</div>';
      }
    }

    function createTrendChart(byWeek) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      const weekLabels = Object.keys(byWeek).sort();
      const weekData = weekLabels.map(w => {
        const stats = byWeek[w];
        return stats.total ? Math.round((stats.done / stats.total) * 100) : 0;
      });

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: weekLabels,
          datasets: [{
            label: 'Weekly Progress %',
            data: weekData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) { return value + '%'; }
              },
              grid: { color: 'rgba(0,0,0,0.1)' }
            },
            x: {
              grid: { color: 'rgba(0,0,0,0.1)' }
            }
          }
        }
      });
    }

    function createHeatmapChart(dailyData) {
      // This is a simplified version - in a real implementation you might want to use a proper heatmap library
      const ctx = document.getElementById('heatmapChart').getContext('2d');
      
      // Group by date and calculate average
      const byDate = {};
      dailyData.forEach(item => {
        if (!byDate[item.date]) byDate[item.date] = [];
        byDate[item.date].push(item.value);
      });
      
      const dates = Object.keys(byDate).sort().slice(-42); // Last 6 weeks
      const avgValues = dates.map(date => {
        const values = byDate[date];
        return values.length ? values.reduce((a,b) => a+b) / values.length : 0;
      });

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dates.map(d => new Date(d).toLocaleDateString()),
          datasets: [{
            label: 'Daily Consistency',
            data: avgValues.map(v => Math.round(v * 100)),
            backgroundColor: avgValues.map(v => {
              if (v >= 0.9) return '#10b981';
              if (v >= 0.7) return '#f59e0b';
              return '#ef4444';
            }),
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) { return value + '%'; }
              },
              grid: { color: 'rgba(0,0,0,0.1)' }
            },
            x: {
              grid: { display: false },
              ticks: { maxRotation: 45 }
            }
          }
        }
      });
    }

    // Initialize dashboard
    main();
  </script>
</body>
</html>
