<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Discipleship 90-Day Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --shadow:0 8px 24px rgba(0,0,0,.06);
    --radius:16px;
    --heat0:#eef2ff; --heat33:#c7d2fe; --heat66:#93c5fd; --heat100:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  header{padding:20px 24px 8px;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:clamp(20px,3vw,28px)}
  header .who{color:var(--muted);font-size:14px}
  .wrap{padding:0 24px 40px;max-width:1200px;margin:0 auto}
  .grid{display:grid;gap:18px}
  .kpis{grid-template-columns:repeat(4,minmax(0,1fr))}
  .mid{grid-template-columns:2fr 1.4fr}
  .bottom{grid-template-columns:1.6fr 1.4fr}
  @media (max-width:980px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}.mid,.bottom{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 8px;font-size:16px;color:var(--muted);font-weight:600;letter-spacing:.2px}
  .big{font-size:clamp(22px,4vw,30px);margin:6px 0 4px;font-weight:800}
  .sub{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;font-size:12px;font-weight:600;margin-top:6px}
  .ok{background:#e8f8ee;color:#065f46}
  .warn{background:#fff7e6;color:#92400e}
  .bad{background:#fdeaea;color:#991b1b}
  .section h2{font-size:18px;margin:0 0 12px;color:#111827}
  canvas{width:100%;height:auto;max-height:420px}
  /* Heatmap */
  .heat{display:grid;grid-template-columns:repeat(14,1fr);gap:4px}
  .cell{height:18px;border-radius:4px;background:var(--heat0)}
  .c0{background:var(--heat0)} .c33{background:var(--heat33)}
  .c66{background:var(--heat66)} .c100{background:var(--heat100)}
  .legend{display:flex;align-items:center;gap:10px;margin-top:10px}
  .swatch{width:24px;height:12px;border-radius:3px;border:1px solid #e5e7eb}
  /* Word cloud */
  .cloudWrap{position:relative; height:340px; background:#f8fafc; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb}
  .word{position:absolute; font-weight:800; line-height:1; white-space:nowrap; opacity:.92}
  .w1{font-size:14px} .w2{font-size:18px}
  .w3{font-size:22px} .w4{font-size:28px}
  .w5{font-size:36px} .w6{font-size:48px}
  .palette1{color:#2563eb} .palette2{color:#16a34a}
  .palette3{color:#f59e0b} .palette4{color:#dc2626}
  .palette5{color:#0ea5e9} .palette6{color:#9333ea}
</style>
</head>
<body>
<header>
  <h1>Discipleship 90-Day Dashboard</h1>
  <div class="who">Participant: <span id="who">—</span></div>
</header>

<div class="wrap">
  <!-- KPI CARDS -->
  <div class="grid kpis">
    <div class="card"><h3>Overall Attainment</h3><div id="attainment" class="big">—</div><div id="attnFlag" class="pill">—</div></div>
    <div class="card"><h3>On-Track vs Expected</h3><div id="ontrack" class="big">—</div><div class="sub">Completed vs expected (today)</div></div>
    <div class="card"><h3>Days Passed / Left</h3><div id="days" class="big">—</div><div id="period" class="sub"></div></div>
    <div class="card"><h3>Weakest Area</h3><div id="weak" class="big">—</div><div class="sub">Focus here this week</div></div>
  </div>

  <!-- MID -->
  <div class="grid mid section" style="margin-top:18px;">
    <div class="card"><h2>Weekly Attainment Trend</h2><canvas id="trend"></canvas></div>
    <div class="card"><h2>Practice Balance (Radar)</h2><canvas id="radar"></canvas><div id="projection" class="sub" style="margin-top:8px"></div></div>
  </div>

  <!-- BOTTOM -->
  <div class="grid bottom section" style="margin-top:18px;">
    <div class="card">
      <h2>Daily Consistency Heatmap (last 6 weeks)</h2>
      <div id="heat" class="heat"></div>
      <div class="legend">
        <span class="sub">Legend:</span>
        <div class="swatch" style="background:var(--heat0)"></div><span class="sub">0 / 3</span>
        <div class="swatch" style="background:var(--heat33)"></div><span class="sub">1 / 3</span>
        <div class="swatch" style="background:var(--heat66)"></div><span class="sub">2 / 3</span>
        <div class="swatch" style="background:var(--heat100)"></div><span class="sub">3 / 3</span>
      </div>
      <div id="streaks" class="sub" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <h2>Reasons Mentioned (Word Cloud)</h2>
      <div id="cloud" class="cloudWrap"></div>
      <div id="cloudHint" class="sub" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
  /* ======= CONFIG ======= */
  const FACT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQERkbRqvUyktHeUw-DvLVNNIzvR50N0oHC-bpDwx6Lj33-o9uIiGN-ucd9r80Tq3l5_WroECTpI-gz/pub?gid=262595972&single=true&output=csv";
  const TARGET = 0.95;
  const DAILY_PRACTICES = new Set(["Bible Reading","Morning Intimacy","Midnight Intercessory Prayer"]);

  /* ======= HELPERS ======= */
  const pid = (new URLSearchParams(location.search).get("id") || "").trim().toLowerCase();
  document.getElementById("who").textContent = pid || "(add ?id=email)";

  function csvToRows(text){
    const lines = text.trim().split(/\r?\n/);
    const header = lines.shift().split(",");
    return lines.map(line=>{
      const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,""));
      const o={}; header.forEach((h,i)=>o[h.trim()]= (cols[i]||"").trim());
      return o;
    });
  }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function sod(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function pd(s){ const d=new Date(s); return isNaN(d)?null:d; }
  function pct(x){ return (Math.round(x*1000)/10).toFixed(1)+"%"; }
  function fetchCSV(url){ return fetch(url+(url.includes("?")?"&":"?")+"cb="+Date.now()).then(r=>r.text()).then(csvToRows); }
  function getRowPid(row){
    const cands = ["participant_id","Email Address","email address","Email","email"];
    for (const want of cands){
      const found = Object.keys(row).find(h => h.toLowerCase()===want.toLowerCase());
      if (found && row[found]) return String(row[found]).trim().toLowerCase();
    }
    return "";
  }
  function longestStreak(vals){ let best=0,cur=0; for(const v of vals){ cur=v?cur+1:0; best=Math.max(best,cur); } return best; }
  function findKeyExactish(row, target){
    const want = target.replace(/[\s_]+/g,"").toLowerCase();
    return Object.keys(row).find(k => k.replace(/[\s_]+/g,"").toLowerCase() === want) || null;
  }
  function rand(min,max){ return Math.random()*(max-min)+min; }

  (async function main(){
    if(!pid) return;

    const factAll = await fetchCSV(FACT_CSV_URL);
    const fact = factAll.filter(r => getRowPid(r)===pid);

    if (!fact.length){
      document.body.insertAdjacentHTML("beforeend","<div class='wrap'><p>No data yet for this participant.</p></div>");
      return;
    }

    // comment keys (robust)
    const sample = fact[0];
    const KEY_COMMENT_GENERAL = findKeyExactish(sample, "comment_general") || "comment_general";
    const KEY_COMMENT_OTHER   = findKeyExactish(sample, "comment_other")   || "comment_other";

    // Program timing
    const weekStarts = fact.map(r=>pd(r.week_start)).filter(Boolean).sort((a,b)=>a-b);
    const programStart = sod(weekStarts[0]);
    const today = sod(new Date());
    const dayNum = Math.max(1, Math.min(90, Math.floor((today - programStart)/(1000*60*60*24))+1));
    const daysLeft = Math.max(0, 90 - dayNum);
    const totalWeeksFinal = 13; // ceil(90/7)

    // Aggregations
    let completed=0, possible=0;
    const byPractice={}, byWeek={}, byDayAgg={};
    const commentTexts = [];

    fact.forEach(r=>{
      const val = Number(r.value||0);
      possible += 1; completed += val;

      const prac = r.practice;
      byPractice[prac] = byPractice[prac] || {done:0,total:0};
      byPractice[prac].done += val; byPractice[prac].total += 1;

      const wk = r.week_start;
      byWeek[wk] = byWeek[wk] || {done:0,total:0};
      byWeek[wk].done += val; byWeek[wk].total += 1;

      if (DAILY_PRACTICES.has(prac)) {
        byDayAgg[r.date] = (byDayAgg[r.date]||0) + val; // 0..3
      }

      const cg = (r[KEY_COMMENT_GENERAL]||"").trim();
      const co = (r[KEY_COMMENT_OTHER]  ||"").trim();
      if (cg) commentTexts.push(cg);
      if (co) commentTexts.push(co);
    });

    // KPIs
    const attainment = possible ? (completed/possible) : 0;
    const weeksElapsed = Math.max(1, Math.ceil(dayNum/7));
    const expectedPossible = (dayNum*3) + (weeksElapsed*4);
    const expectedCompletedFor95 = expectedPossible * 0.95;
    const variance = completed - expectedCompletedFor95;

    // Projections
    const totalPossible = (90*3) + (totalWeeksFinal*4);
    const projectedFinalCompleted = completed + attainment*(totalPossible - possible);
    const projectedFinalPct = projectedFinalCompleted / totalPossible;
    const targetFinalCompleted = 0.95 * totalPossible;
    const shortfall = Math.max(0, targetFinalCompleted - projectedFinalCompleted);
    const weeksLeft = Math.max(0, totalWeeksFinal - weeksElapsed);
    const neededPerWeek = weeksLeft ? (shortfall / weeksLeft) : shortfall;

    // Weakest area
    let weakest=null, weakestPct=1;
    Object.keys(byPractice).forEach(k=>{
      const p = byPractice[k]; const ratio = p.total ? p.done/p.total : 0;
      if (ratio < weakestPct){ weakest=k; weakestPct=ratio; }
    });

    // KPI cards
    const attnEl = document.getElementById("attainment");
    const flag = document.getElementById("attnFlag");
    attnEl.textContent = pct(attainment);
    const cls = attainment>=0.95 ? "ok" : (attainment>=0.8 ? "warn" : "bad");
    flag.className = "pill " + cls;
    flag.textContent = attainment>=0.95 ? "On pace for 95%+" : (attainment>=0.8 ? "Needs push" : "At risk");
    document.getElementById("ontrack").textContent = (variance>=0?"+":"")+Math.round(variance*10)/10;
    document.getElementById("days").textContent = `Day ${dayNum} / 90 — ${daysLeft} left`;
    document.getElementById("period").textContent = `Program started ${ymd(programStart)}`;
    document.getElementById("weak").textContent = weakest ? `${weakest} (${pct(weakestPct)})` : "—";

    // Charts
    // Weekly line
    const wLabels = Object.keys(byWeek).sort();
    const wPct = wLabels.map(w => {
      const a = byWeek[w]; return a.total ? Math.round(1000*(a.done/a.total))/10 : 0;
    });
    new Chart(document.getElementById("trend"), {
      type:"line",
      data:{ labels:wLabels, datasets:[{ label:"Weekly Attainment %", data:wPct, borderWidth:3, tension:.25 }] },
      options:{ responsive:true, scales:{ y:{ suggestedMin:0, suggestedMax:100 } } }
    });

    // Radar
    const pLabels = Object.keys(byPractice);
    const pPct = pLabels.map(k => byPractice[k].done/byPractice[k].total*100);
    new Chart(document.getElementById("radar"), {
      type:"radar",
      data:{ labels:pLabels, datasets:[{ label:"% Attainment by Practice", data:pPct, borderWidth:2, pointRadius:3 }] },
      options:{ responsive:true, scales:{ r:{ suggestedMin:0, suggestedMax:100 } } }
    });
    document.getElementById("projection").textContent =
      `Projected finish at ${pct(projectedFinalPct)}. ` +
      (shortfall>0 ? `To hit 95%, aim for ~${Math.ceil(neededPerWeek)} more unit(s) per week for the remaining ${weeksLeft} week(s).`
                    : `You're on track for 95%+ 🎉`);

    // Heatmap last 42 days + legend already in DOM
    const dKeys = Object.keys(byDayAgg).sort().slice(-42);
    const heat = document.getElementById("heat");
    dKeys.forEach(k=>{
      const v = byDayAgg[k]; const ratio = v/3;
      const cls2 = ratio>=1 ? "c100" : ratio>=.66 ? "c66" : ratio>=.33 ? "c33" : "c0";
      const cell = document.createElement("div");
      cell.className = "cell "+cls2; cell.title = `${k}: ${(ratio*100).toFixed(0)}%`;
      heat.appendChild(cell);
    });

    // Streaks: full day = all 3 daily completed
    const orderedDaily = dKeys.map(k => byDayAgg[k] >= 3 ? 1 : 0);
    const longest = longestStreak(orderedDaily);
    const current = (()=>{ let c=0; for(let i=orderedDaily.length-1;i>=0;i--){ if(orderedDaily[i]) c++; else break; } return c; })();
    document.getElementById("streaks").textContent =
      `Longest full-day streak: ${longest} day(s) · Current full-day streak: ${current} day(s)`;

    /* ===== Word Cloud from comment_general + comment_other ===== */
    // Build frequency
    const STOP = new Set(("the a an and or to of in for with on at is are am be this that it as i we you they he she was were have has had from by not n/a na week weeks day days because due just really very i’m im ive i've").split(" "));
    const freq = {};
    let samples = 0;
    fact.forEach(r=>{
      const cg = (r[KEY_COMMENT_GENERAL]||"").toLowerCase().trim();
      const co = (r[KEY_COMMENT_OTHER]  ||"").toLowerCase().trim();
      const text = (cg + " " + co).trim();
      if (!text || /^n\/?a$/.test(text)) return;
      samples++;
      text.replace(/[^a-z0-9\s]/g," ").split(/\s+/).forEach(w=>{
        if(!w || STOP.has(w)) return;
        freq[w] = (freq[w]||0)+1;
      });
    });

    const cloud = document.getElementById("cloud");
    cloud.innerHTML = "";
    if (!samples){
      document.getElementById("cloudHint").textContent = "No comments yet";
      return;
    }
    document.getElementById("cloudHint").textContent = `${samples} comment(s)`;

    const entries = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,40);
    const max = entries[0]?.[1] || 1;
    const palettes = ["palette1","palette2","palette3","palette4","palette5","palette6"];

    // Place words in the container randomly (simple packing)
    const W = cloud.clientWidth, H = cloud.clientHeight;
    entries.forEach(([w,c],i)=>{
      const weight = c/max;
      // 6 size buckets (bigger for frequent)
      const bucket = weight>.9?6: weight>.75?5: weight>.6?4: weight>.45?3: weight>.3?2:1;
      const span = document.createElement("div");
      span.className = `word w${bucket} ${palettes[i%palettes.length]}`;
      span.textContent = w;
      // slight rotations (-15..15 deg) except the very largest to keep readable
      const rot = bucket>=6 ? 0 : (Math.random()<0.5? -1:1) * Math.floor(rand(5,15));
      span.style.transform = `rotate(${rot}deg)`;
      // random position with padding
      const pad = 18;
      const left = Math.max(4, Math.min(W-120, rand(pad, W-pad-120)));
      const top  = Math.max(4, Math.min(H-40, rand(pad, H-pad-40)));
      span.style.left = left+"px";
      span.style.top = top+"px";
      cloud.appendChild(span);
    });
  })();
</script>
</body>
</html>
