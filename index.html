/**
 * MAP YOUR EXACT FORM QUESTION TITLES HERE (case-sensitive)
 * Updated: participantId points to "Email Address"
 */
const Q = {
  timestamp: "Timestamp",
  name: "Name",
  participantId: "Email Address",
  weekStart: "What week are you reporting for? Choose the Sunday that began the week you are reporting for.",
  // Daily (checkboxes for days)
  bibleReading: "Bible Reading",
  morningIntimacy: "Morning Intimacy",
  scriptureMem: "Scripture Memorization",                 // <-- DAILY now
  // Weekly (single choice Fully/Partially/Not)
  fasting: "Fasting",
  studyMeditation: "Bible Study & Meditation",
  midnightPrayer: "Midnight Intercessory Prayer",         // <-- WEEKLY now (pick a day, but 1 per week)
  corporatePrayers: "Corporate Gathering Prayers Commitment",
  // Comments
  commentMisses: "Please make a general comment on any of the above commitment that was not completed or partially completed this week. If you completed everything, please type N/A",
  commentOther: "Any other comments?"
};

// Fallbacks
const PID_FALLBACK_KEYS = ["Participant ID (email or phone)", "Email", "Email Address", "Email address"];
const WEEK_FALLBACK_CONTAINS = "what week are you reporting for";

const DAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const FACT_SHEET = "fact_commitments";
const RESPONSES_SHEET_PREFIX = "Form Responses";

/********* TRIGGER ENTRY *********/
function onFormSubmit(e) {
  const row = fromNamedValues(e.namedValues);
  writeFactRows(row);
}

/********* ONE-TIME UTILITIES *********/
function createTrigger() {
  ScriptApp.getProjectTriggers().forEach(t => {
    if (t.getHandlerFunction() === "onFormSubmit") ScriptApp.deleteTrigger(t);
  });
  ScriptApp.newTrigger("onFormSubmit")
    .forSpreadsheet(SpreadsheetApp.getActive())
    .onFormSubmit()
    .create();
}

// Backfill fact_commitments from existing "Form Responses 1"
function backfillAll() {
  const ss = SpreadsheetApp.getActive();
  const resp = ss.getSheets().find(s => s.getName().startsWith(RESPONSES_SHEET_PREFIX));
  if (!resp) throw new Error("Couldn't find the Form responses sheet.");
  const data = resp.getDataRange().getValues();
  const header = data[0];
  const rows = data.slice(1).filter(r => r.join("").trim() !== "");
  const namedRows = rows.map(r => {
    const o = {};
    header.forEach((h,i)=> o[h] = r[i]);
    return o;
  });

  const fact = ss.getSheetByName(FACT_SHEET);
  if (!fact) throw new Error("Create a sheet named 'fact_commitments' with header row first.");
  // clear existing (keep header)
  if (fact.getLastRow() > 1) {
    fact.getRange(2,1,fact.getLastRow()-1,fact.getLastColumn()).clearContent();
  }

  const out = [];
  namedRows.forEach(src => out.push(...buildRows(src)));
  if (out.length) fact.getRange(2,1,out.length,out[0].length).setValues(out);
}

/********* HELPERS *********/
function fromNamedValues(named) {
  const out = {};
  Object.keys(named).forEach(k => out[k] = (named[k] && named[k][0]) || "");
  return out;
}
function parseDateOrNull(s) { const d = new Date(s); return isNaN(d.getTime()) ? null : d; }
function ymd(d) { return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd"); }
function weeklyToValue(s) {
  const v = String(s || "").toLowerCase();
  if (v.startsWith("fully")) return 1;
  if (v.startsWith("part"))  return 0.5;
  if (v.startsWith("not"))   return 0;
  return "";
}
function parseDayChecks(multiselect) {
  const set = new Set(String(multiselect || "").split(",").map(s => s.trim()).filter(Boolean));
  return DAYS.map(d => set.has(d));
}
function pick(obj, keys, containsLower) {
  for (const k of keys) if (obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
  if (containsLower) {
    const found = Object.keys(obj).find(k => k.toLowerCase().includes(containsLower));
    if (found) return obj[found];
  }
  return "";
}
function toPid(src){
  const pidRaw = src[Q.participantId] || pick(src, PID_FALLBACK_KEYS);
  return String(pidRaw || "").trim().toLowerCase();
}
function toWeekStart(src){
  const raw = src[Q.weekStart] || pick(src, [], WEEK_FALLBACK_CONTAINS);
  return parseDateOrNull(raw);
}

/********* CORE *********/
function writeFactRows(src) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const fact = ss.getSheetByName(FACT_SHEET);
  if (!fact) throw new Error("Create a sheet named 'fact_commitments' with header row first.");

  const pid = toPid(src);
  if (!pid) throw new Error("Participant ID (email) not found. Check the Q.participantId label or enable 'Collect email addresses'.");

  const weekStart = toWeekStart(src);
  if (!weekStart) throw new Error("Week start date missing or invalid.");

  const outRows = buildRows(src, pid, weekStart);
  if (outRows.length) {
    fact.getRange(fact.getLastRow() + 1, 1, outRows.length, outRows[0].length).setValues(outRows);
  }
}

function buildRows(src, pidParam, weekStartParam) {
  const pid = pidParam || toPid(src);
  const weekStart = weekStartParam || toWeekStart(src);

  const general = (src[Q.commentMisses] || "").toString().trim();
  const other   = (src[Q.commentOther]  || "").toString().trim();

  const out = [];

  // === DAILY (7 rows each) ===
  [
    {field: Q.bibleReading,   practice: "Bible Reading"},
    {field: Q.morningIntimacy,practice: "Morning Intimacy"},
    {field: Q.scriptureMem,   practice: "Scripture Memorization"} // <— daily now
  ].forEach(def => {
    const checks = parseDayChecks(src[def.field]);
    for (let i=0; i<7; i++) {
      const d = new Date(weekStart.getTime());
      d.setDate(d.getDate()+i);
      out.push([pid, ymd(weekStart), ymd(d), def.practice, "daily", checks[i] ? 1 : 0, general, other]);
    }
  });

  // === WEEKLY (1 row each) ===
  [
    {field: Q.fasting,           practice: "Fasting"},
    {field: Q.studyMeditation,   practice: "Bible Study & Meditation"},
    {field: Q.midnightPrayer,    practice: "Midnight Intercessory Prayer"}, // <— weekly now
    {field: Q.corporatePrayers,  practice: "Corporate Gathering Prayers Commitment"}
  ].forEach(def => {
    const val = weeklyToValue(src[def.field]);
    if (val !== "") {
      out.push([pid, ymd(weekStart), ymd(weekStart), def.practice, "weekly", val, general, other]);
    }
  });

  return out;
}
