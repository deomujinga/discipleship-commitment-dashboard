<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Discipleship 90-Day Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --light-muted:#9ca3af;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --shadow:0 8px 24px rgba(0,0,0,.06);
    --radius:16px; --border:#e5e7eb;
    --read:#3b82f6; --intimacy:#06b6d4; --memory:#7c3aed; --empty:#e5e7eb;
    --target:#10b981; --improvement:#059669; --decline:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.5}
  
  /* Loading state */
  .loading{opacity:0.7;pointer-events:none}
  .loading-spinner{width:20px;height:20px;border:2px solid var(--border);border-top:2px solid var(--read);border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  
  /* Header improvements */
  header{padding:24px 24px 12px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,var(--card) 0%,#f8fafc 100%);border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:clamp(24px,3.5vw,32px);font-weight:800;background:linear-gradient(135deg,var(--ink) 0%,var(--read) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  header .who{color:var(--muted);font-size:14px;font-weight:500}
  
  .wrap{padding:0 24px 40px;max-width:1400px;margin:0 auto}

  /* Responsive grid improvements */
  .kpis{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  @media (max-width:768px){.kpis{grid-template-columns:repeat(2,1fr);gap:16px}}
  @media (max-width:480px){.kpis{grid-template-columns:1fr}}
  
  .grid{display:grid;gap:20px}
  .mid{grid-template-columns:2fr 1.4fr}
  .bottom{grid-template-columns:1.6fr 1.4fr}
  @media (max-width:1024px){.mid,.bottom{grid-template-columns:1fr}}

  /* Enhanced card styling */
  .card{
    background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:24px;border:1px solid var(--border);position:relative;overflow:hidden;
    transition:all 0.3s ease;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.08)}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--read),var(--intimacy),var(--memory));opacity:0.8}
  
  .card h3{margin:0 0 12px;font-size:16px;color:var(--muted);font-weight:600;letter-spacing:.3px;text-transform:uppercase}
  .card h2{font-size:20px;margin:0 0 20px;color:#111827;font-weight:700;display:flex;align-items:center;gap:8px}
  
  /* Enhanced KPI styling */
  .big{font-size:clamp(28px,5vw,36px);margin:8px 0 6px;font-weight:900;line-height:1}
  .sub{font-size:13px;color:var(--muted);line-height:1.4}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid var(--border);font-size:12px;font-weight:600;margin-top:8px;transition:all 0.2s ease}
  .ok{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
  .warn{background:#fef3c7;color:#92400e;border-color:#fde68a}
  .bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}
  
  /* Trend indicators */
  .trend-indicator{font-size:14px;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-left:8px}
  .trend-up{color:var(--improvement)} .trend-down{color:var(--decline)} .trend-neutral{color:var(--muted)}
  .trend-arrow{font-size:12px}
  
  /* Progress bars */
  .progress-container{margin:12px 0 8px;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
  .progress-bar{height:100%;background:linear-gradient(90deg,var(--read),var(--intimacy));border-radius:4px;transition:width 0.8s ease;position:relative}
  .progress-bar::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite}
  @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  
  /* Streak counter */
  .streak{background:var(--improvement);color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:700;display:inline-block;margin-top:6px}

  /* Chart container improvements */
  .chart-container{position:relative;height:360px}
  canvas{width:100%!important;height:100%!important;max-height:360px}

  /* Enhanced heatmap */
  .heatmap-container{
    background:linear-gradient(135deg,#f8fafc 0%,#ffffff 100%);
    border-radius:16px;padding:20px;border:1px solid var(--border);
    box-shadow:inset 0 1px 3px rgba(0,0,0,0.05);
  }
  
  .month-labels{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}
  .month-label{text-align:center;font-size:10px;font-weight:600;color:var(--light-muted);padding:2px 0}
  
  .day-headers{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:12px}
  .day-header{text-align:center;font-size:12px;font-weight:700;color:var(--muted);padding:6px 0}
  
  .heat-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  
  .day-cell{
    aspect-ratio:1;min-height:42px;background:#ffffff;border-radius:10px;
    padding:5px;display:grid;grid-template-rows:repeat(3,1fr);gap:2px;
    border:2px solid var(--border);position:relative;
    transition:all 0.3s cubic-bezier(0.4,0,0.2,1);cursor:pointer;
  }
  .day-cell:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 8px 20px rgba(0,0,0,0.12);border-color:var(--read)}
  .day-cell.empty{background:#f9fafb;border:1px solid #f1f5f9;cursor:default}
  .day-cell.empty:hover{transform:none;box-shadow:none;border-color:#f1f5f9}
  
  .practice-bar{
    border-radius:4px;background:var(--empty);display:flex;align-items:center;justify-content:center;
    position:relative;transition:all 0.3s ease;box-shadow:inset 0 1px 2px rgba(0,0,0,0.05);
  }
  .practice-bar .practice-label{font-size:9px;font-weight:800;color:var(--light-muted);line-height:1}
  .practice-bar.completed .practice-label{color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
  .practice-bar.read.completed{background:linear-gradient(135deg,var(--read),#2563eb)}
  .practice-bar.intimacy.completed{background:linear-gradient(135deg,var(--intimacy),#0891b2)}
  .practice-bar.memory.completed{background:linear-gradient(135deg,var(--memory),#7c3aed)}
  
  .day-number{
    position:absolute;top:-8px;right:-8px;background:#ffffff;border:2px solid var(--border);
    border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;
    font-size:9px;font-weight:700;color:var(--ink);box-shadow:0 2px 4px rgba(0,0,0,0.1);
  }
  
  .week-summary{
    display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:8px;
    padding:8px 0;border-top:1px solid var(--border);
  }
  .week-cell{
    text-align:center;font-size:10px;font-weight:600;color:var(--muted);
    padding:4px 2px;border-radius:4px;
  }
  .week-cell.good{background:#dcfce7;color:#065f46}
  .week-cell.okay{background:#fef3c7;color:#92400e}
  .week-cell.poor{background:#fee2e2;color:#991b1b}

  /* Enhanced legend */
  .legend{
    display:flex;align-items:center;gap:20px;margin-top:20px;flex-wrap:wrap;justify-content:center;
    padding:16px;background:rgba(255,255,255,0.5);border-radius:12px;border:1px solid var(--border);
  }
  .chip{
    display:flex;align-items:center;gap:10px;background:#ffffff;
    padding:8px 16px;border-radius:24px;border:1px solid var(--border);
    box-shadow:0 2px 4px rgba(0,0,0,0.05);transition:all 0.2s ease;
  }
  .chip:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
  .color-swatch{width:18px;height:18px;border-radius:6px;border:2px solid rgba(255,255,255,0.3);box-shadow:0 1px 3px rgba(0,0,0,0.2)}
  .chip-label{font-size:13px;font-weight:600;color:var(--ink)}

  /* Insights section */
  .insights{
    background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);
    border:1px solid #0ea5e9;border-radius:12px;padding:16px;margin-top:16px;
  }
  .insights h4{margin:0 0 8px;color:#0c4a6e;font-size:14px;font-weight:700}
  .insights p{margin:0;color:#0c4a6e;font-size:12px;line-height:1.4}

  /* Tooltip */
  .tooltip{
    position:absolute;background:#1f2937;color:white;padding:8px 12px;
    border-radius:8px;font-size:12px;pointer-events:none;z-index:1000;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.2s ease;
  }
  .tooltip.show{opacity:1}
  .tooltip::after{
    content:'';position:absolute;top:100%;left:50%;margin-left:-4px;
    border:4px solid transparent;border-top-color:#1f2937;
  }

  /* Word cloud improvements */
  .cloudWrap{
    position:relative;height:360px;
    background:linear-gradient(135deg,#f8fafc 0%,#ffffff 100%);
    border-radius:16px;overflow:hidden;border:1px solid var(--border);
    box-shadow:inset 0 1px 3px rgba(0,0,0,0.05);
  }
  .word{
    position:absolute;font-weight:800;line-height:1;white-space:nowrap;
    opacity:.9;transition:all 0.3s ease;cursor:pointer;
  }
  .word:hover{opacity:1;transform:scale(1.1);z-index:10}
  .w1{font-size:14px} .w2{font-size:18px} .w3{font-size:22px}
  .w4{font-size:28px} .w5{font-size:36px} .w6{font-size:48px}
  .palette1{color:#2563eb} .palette2{color:#16a34a} .palette3{color:#f59e0b}
  .palette4{color:#dc2626} .palette5{color:#0ea5e9} .palette6{color:#9333ea}

  /* Mobile responsiveness */
  @media (max-width:768px){
    .wrap{padding:0 16px 32px}
    .card{padding:20px}
    .day-cell{min-height:36px}
    .practice-label{font-size:8px}
    .legend{gap:12px;padding:12px}
    .chip{padding:6px 12px;gap:8px}
  }
  
  @media (max-width:480px){
    header{padding:20px 16px 8px}
    .card{padding:16px}
    .day-cell{min-height:32px;padding:3px;gap:1px}
    .practice-label{font-size:7px}
    .day-number{width:16px;height:16px;font-size:8px}
  }
</style>
</head>
<body>
<header>
  <h1>Discipleship 90-Day Dashboard</h1>
  <div class="who">Participant: <span id="who">—</span></div>
</header>

<div class="wrap">
  <div id="loading" class="loading-spinner" style="display:none;"></div>
  
  <!-- KPI CARDS -->
  <div class="kpis">
    <div class="card">
      <h3>Overall Attainment</h3>
      <div id="attainment" class="big">—</div>
      <div class="progress-container">
        <div id="attainmentProgress" class="progress-bar" style="width:0%"></div>
      </div>
      <div id="attnFlag" class="pill">—</div>
      <div class="sub">Completed so far ÷ possible so far. Target ≥ 95% to succeed by Day 90.</div>
    </div>

    <div class="card">
      <h3>On-Track vs Expected</h3>
      <div style="display:flex;align-items:center">
        <div id="ontrack" class="big">—</div>
        <div id="trackTrend" class="trend-indicator"></div>
      </div>
      <div id="ontrackHelp" class="sub">Ahead/behind the 95% pace based on how many units should be done by today.</div>
    </div>

    <div class="card">
      <h3>Days Passed / Left</h3>
      <div id="days" class="big">—</div>
      <div class="progress-container">
        <div id="daysProgress" class="progress-bar" style="width:0%"></div>
      </div>
      <div id="period" class="sub"></div>
    </div>

    <div class="card">
      <h3>Weakest Area</h3>
      <div id="weak" class="big">—</div>
      <div class="sub">Per-practice attainment (completed ÷ possible) so far.</div>
    </div>

    <div class="card">
      <h3>Strongest Area</h3>
      <div id="strong" class="big">—</div>
      <div id="streak" class="streak" style="display:none;"></div>
      <div class="sub">Per-practice attainment (completed ÷ possible) so far.</div>
    </div>
  </div>

  <!-- MID -->
  <div class="grid mid section" style="margin-top:24px;">
    <div class="card">
      <h2>Weekly Attainment Trend <span id="weeklyTrend" class="trend-indicator"></span></h2>
      <div class="chart-container">
        <canvas id="trend"></canvas>
      </div>
    </div>
    <div class="card">
      <h2>Practice Balance (Radar)</h2>
      <div class="chart-container">
        <canvas id="radar"></canvas>
      </div>
      <div id="projection" class="sub" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- BOTTOM -->
  <div class="grid bottom section" style="margin-top:24px;">
    <div class="card">
      <h2>Daily Consistency Heatmap (last 6 weeks)</h2>
      <div class="heatmap-container">
        <div id="monthLabels" class="month-labels"></div>
        <div class="day-headers">
          <div class="day-header">S</div>
          <div class="day-header">M</div>
          <div class="day-header">T</div>
          <div class="day-header">W</div>
          <div class="day-header">T</div>
          <div class="day-header">F</div>
          <div class="day-header">S</div>
        </div>
        <div id="heat" class="heat-grid"></div>
        <div id="weekSummary" class="week-summary"></div>
      </div>
      <div class="legend">
        <div class="chip">
          <div class="color-swatch" style="background:linear-gradient(135deg,var(--read),#2563eb)"></div>
          <span class="chip-label">Bible Reading</span>
        </div>
        <div class="chip">
          <div class="color-swatch" style="background:linear-gradient(135deg,var(--intimacy),#0891b2)"></div>
          <span class="chip-label">Morning Intimacy</span>
        </div>
        <div class="chip">
          <div class="color-swatch" style="background:linear-gradient(135deg,var(--memory),#7c3aed)"></div>
          <span class="chip-label">Scripture Memorization</span>
        </div>
      </div>
      <div id="insights" class="insights" style="display:none;">
        <h4>Insights</h4>
        <p id="insightText"></p>
      </div>
    </div>
    <div class="card">
      <h2>Reasons Mentioned (Word Cloud)</h2>
      <div id="cloud" class="cloudWrap"></div>
      <div id="cloudHint" class="sub" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
  /* ======= CONFIG ======= */
  const FACT_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQERkbRqvUyktHeUw-DvLVNNIzvR50N0oHC-bpDwx6Lj33-o9uIiGN-ucd9r80Tq3l5_WroECTpI-gz/pub?gid=262595972&single=true&output=csv";
  const TARGET = 0.95;
  const DAILY_PRACTICES = new Set(["Bible Reading","Morning Intimacy","Scripture Memorization"]);
  const DAILY_COLORS = {
    "Bible Reading":"read",
    "Morning Intimacy":"intimacy",
    "Scripture Memorization":"memory"
  };
  const LETTER = {"Bible Reading":"R","Morning Intimacy":"I","Scripture Memorization":"M"};

  /* ======= HELPERS ======= */
  const pid = (new URLSearchParams(location.search).get("id") || "").trim().toLowerCase();
  document.getElementById("who").textContent = pid || "(add ?id=email)";

  function showLoading(show) {
    document.getElementById("loading").style.display = show ? "block" : "none";
    document.querySelector(".wrap").classList.toggle("loading", show);
  }

  function csvToRows(text){
    const lines = text.trim().split(/\r?\n/);
    const header = lines.shift().split(",");
    return lines.map(line=>{
      const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,""));
      const o={}; header.forEach((h,i)=>o[h.trim()]= (cols[i]||"").trim());
      return o;
    });
  }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function sod(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function pd(s){ const d=new Date(s); return isNaN(d)?null:d; }
  function pct(x){ return (Math.round(x*1000)/10).toFixed(1)+"%"; }
  function fetchCSV(url){ return fetch(url+(url.includes("?")?"&":"?")+"cb="+Date.now()).then(r=>r.text()).then(csvToRows); }
  function getRowPid(row){
    const cands = ["participant_id","Email Address","email address","Email","email"];
    for (const want of cands){
      const found = Object.keys(row).find(h => h.toLowerCase()===want.toLowerCase());
      if (found && row[found]) return String(row[found]).trim().toLowerCase();
    }
    return "";
  }
  function findKeyExactish(row, target){
    const want = target.replace(/[\s_]+/g,"").toLowerCase();
    return Object.keys(row).find(k => k.replace(/[\s_]+/g,"").toLowerCase() === want) || null;
  }

  function getTrendIndicator(current, previous) {
    if (!previous) return '';
    const diff = current - previous;
    if (Math.abs(diff) < 0.1) return '<span class="trend-neutral">→</span>';
    return diff > 0 ? 
      '<span class="trend-up">↗ <span class="trend-arrow">+' + diff.toFixed(1) + '%</span></span>' :
      '<span class="trend-down">↘ <span class="trend-arrow">' + diff.toFixed(1) + '%</span></span>';
  }

  function calculateStreak(dayMap) {
    const dates = Object.keys(dayMap).sort().reverse();
    let streak = 0;
    for (const date of dates) {
      const day = dayMap[date];
      const complete = ["Bible Reading","Morning Intimacy","Scripture Memorization"]
        .every(p => day[p] >= 1);
      if (complete) streak++;
      else break;
    }
    return streak;
  }

  function getBestDay(dayMap) {
    const dayOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const dayStats = {};
    
    Object.entries(dayMap).forEach(([date, practices]) => {
      const day = new Date(date).getDay();
      const dayName = dayOfWeek[day];
      if (!dayStats[dayName]) dayStats[dayName] = {total: 0, complete: 0};
      dayStats[dayName].total++;
      if (["Bible Reading","Morning Intimacy","Scripture Memorization"].every(p => practices[p] >= 1)) {
        dayStats[dayName].complete++;
      }
    });

    let bestDay = '';
    let bestRate = 0;
    Object.entries(dayStats).forEach(([day, stats]) => {
      const rate = stats.total > 0 ? stats.complete / stats.total : 0;
      if (rate > bestRate && stats.total >= 3) { // Need at least 3 samples
        bestRate = rate;
        bestDay = day;
      }
    });

    return bestDay ? `${bestDay}s (${pct(bestRate)} complete)` : '';
  }

  (async function main(){
    if(!pid) return;

    showLoading(true);

    try {
      const factAll = await fetchCSV(FACT_CSV_URL);
      const fact = factAll.filter(r => getRowPid(r)===pid);

      if (!fact.length){
        document.body.insertAdjacentHTML("beforeend","<div class='wrap'><p>No data yet for this participant.</p></div>");
        return;
      }

      // comment keys (robust)
      const sample = fact[0];
      const KEY_COMMENT_GENERAL = findKeyExactish(sample, "comment_general") || "comment_general";
      const KEY_COMMENT_OTHER   = findKeyExactish(sample, "comment_other")   || "comment_other";

      // Program timing
      const weekStarts = fact.map(r=>pd(r.week_start)).filter(Boolean).sort((a,b)=>a-b);
      const programStart = sod(weekStarts[0]);
      const today = sod(new Date());
      const dayNum = Math.max(1, Math.min(90, Math.floor((today - programStart)/(1000*60*60*24))+1));
      const daysLeft = Math.max(0, 90 - dayNum);
      const totalWeeksFinal = 13;

      // Aggregations
      let completed=0, possible=0;
      const byPractice={}, byWeek={};
      const dayMap = {};
      const comments = [];

      fact.forEach(r=>{
        const val = Number(r.value||0);
        possible += 1; completed += val;

        const prac = r.practice;
        byPractice[prac] = byPractice[prac] || {done:0,total:0};
        byPractice[prac].done += val; byPractice[prac].total += 1;

        const wk = r.week_start;
        byWeek[wk] = byWeek[wk] || {done:0,total:0};
        byWeek[wk].done += val; byWeek[wk].total += 1;

        if (DAILY_PRACTICES.has(prac)) {
          const d = r.date;
          if (!dayMap[d]) dayMap[d] = {"Bible Reading":0,"Morning Intimacy":0,"Scripture Memorization":0};
          dayMap[d][prac] = Math.min(1, Number(r.value||0));
        }

        const cg = (r[KEY_COMMENT_GENERAL]||"").trim();
        const co = (r[KEY_COMMENT_OTHER]  ||"").trim();
        if (cg) comments.push(cg);
        if (co) comments.push(co);
      });

      // KPIs with enhancements
      const attainment = possible ? (completed/possible) : 0;
      const weeksElapsed = Math.max(1, Math.ceil(dayNum/7));
      const expectedPossible = (dayNum*3) + (weeksElapsed*4);
      const expectedCompletedFor95 = expectedPossible * 0.95;
      const variance = Math.round((completed - expectedCompletedFor95)*10)/10;

      // Projections
      const totalPossible = (90*3) + (totalWeeksFinal*4);
      const projectedFinalCompleted = completed + attainment*(totalPossible - possible);
      const projectedFinalPct = projectedFinalCompleted / totalPossible;
      const targetFinalCompleted = 0.95 * totalPossible;
      const shortfall = Math.max(0, targetFinalCompleted - projectedFinalCompleted);
      const weeksLeft = Math.max(0, totalWeeksFinal - weeksElapsed);
      const neededPerWeek = weeksLeft ? (shortfall / weeksLeft) : shortfall;

      // Calculate streak
      const currentStreak = calculateStreak(dayMap);

      // Weakest & Strongest areas
      let weakest=null, weakestPct=1, strongest=null, strongestPct=-1;
      Object.keys(byPractice).forEach(k=>{
        const p = byPractice[k]; const ratio = p.total ? p.done/p.total : 0;
        if (ratio < weakestPct){ weakest=k; weakestPct=ratio; }
        if (ratio > strongestPct){ strongest=k; strongestPct=ratio; }
      });

      // Fill KPI cards with enhancements
      document.getElementById("attainment").textContent = pct(attainment);
      document.getElementById("attainmentProgress").style.width = (attainment * 100) + "%";
      
      const flag = document.getElementById("attnFlag");
      flag.className = "pill " + (attainment>=0.95 ? "ok" : attainment>=0.8 ? "warn" : "bad");
      flag.textContent = attainment>=0.95 ?
